<div class="container mx-auto px-4 py-8">
  <!-- Volver -->
  <div class="mb-6">
    <a routerLink="/profile"
       class="inline-flex items-center px-4 py-2 border rounded-md text-gray-700 hover:bg-gray-100 mb-4">
      <lucide-angular [img]="ArrowLeft" class="h-4 w-4 mr-2"></lucide-angular>
      Volver al Perfil
    </a>

    <!-- Encabezado (solo si ya hay datos) -->
    @if (applicationData) {
      <div class="flex flex-col md:flex-row md:items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-[#001F3F] mb-2">{{ applicationData.vacante }}</h1>
          <div class="text-gray-600 mb-2 font-medium">{{ applicationData.nombreDepartamento }}</div>
          <div class="flex items-center text-gray-500">
            <lucide-angular [img]="MapPin" class="h-4 w-4 mr-1"></lucide-angular>
            {{ applicationData.direccion }}
          </div>
        </div>
        <div class="mt-4 md:mt-0">
          <span class="inline-flex items-center px-2 py-1 rounded-md text-sm font-medium"
                [ngClass]="getStatusClass(applicationData.estadoId)">
            <i [class]="getStatusIcon(applicationData.estadoId) + ' h-5 w-5 mr-1'"></i>
            {{ getStatusLabelById(applicationData.estadoId) }}
          </span>
        </div>
      </div>
    } @else {
      <!-- Skeleton simple -->
      <div class="animate-pulse space-y-2">
        <div class="h-6 w-1/3 bg-gray-200 rounded"></div>
        <div class="h-4 w-1/4 bg-gray-200 rounded"></div>
        <div class="h-4 w-1/5 bg-gray-200 rounded"></div>
      </div>
    }
  </div>

  <div class="grid gap-6 lg:grid-cols-3">
    <!-- Contenido principal -->
    <div class="lg:col-span-2 space-y-6">

      <!-- Mensajes + Comentarios -->
      <div class="border rounded-lg shadow-sm p-4">
        <h2 class="flex items-center text-lg font-semibold mb-4">
          <lucide-angular [img]="MessageSquare" class="h-5 w-5 mr-2"></lucide-angular>
          Mensajes y Comentarios
        </h2>

        <div class="space-y-6 max-h-[500px] overflow-y-auto pr-2">
          <!-- Lista paginada desde API -->
          @for (message of messages; track $index) {
            <div class="border-l-4 border-blue-200 pl-4 py-3">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                  <i [class]="getMessageIcon(message.typeId) + ' h-4 w-4'"></i>
                  <span class="text-sm text-gray-500 ml-2">
                    {{ message.date }} • {{ message.typeName }}
                  </span>
                </div>
                <div class="text-xs text-gray-500">
                  {{ message.replies.length || 0 }}
                  {{ (message.replies.length || 0) === 1 ? 'respuesta' : 'respuestas' }}
                </div>
              </div>

              <p class="text-gray-800 whitespace-pre-line font-semibold">{{ message.message }}</p>

              <!-- Respuestas -->
              @if (message.replies.length) {
                <div class="mt-3 space-y-3">
                  @for (r of message.replies; track $index) {
                    <div class="ml-3 border rounded-md p-3 bg-gray-50">
                      <div class="text-xs text-gray-500 mb-1">{{ r.date }}</div>
                      <p class="text-gray-700 whitespace-pre-line">{{ r.text }}</p>
                    </div>
                  }
                </div>
              }

              <!-- Acciones -->
              <div class="mt-3 flex items-center gap-3">
                <button
                  class="text-sm px-3 py-1 rounded-md border hover:bg-gray-50"
                  (click)="toggleReplyBox(message.id)">
                  Responder
                </button>
              </div>

              <!-- Caja de respuesta -->
              @if (replyBoxes[message.id]) {
                <div class="mt-3">
                  <textarea [(ngModel)]="replyText[message.id]" rows="3"
                            placeholder="Escribe tu respuesta…"
                            class="w-full border rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                  <div class="mt-2 flex items-center gap-2">
                    <button
                      class="bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-1 rounded-md disabled:opacity-50"
                      [disabled]="!(replyText[message.id]?.trim?.())"
                      (click)="addReply(message.id)">
                      Enviar
                    </button>
                    <button
                      class="text-sm px-3 py-1 rounded-md border hover:bg-gray-50"
                      (click)="cancelReply(message.id)">
                      Cancelar
                    </button>
                  </div>
                </div>
              }
            </div>
          }

          <!-- Paginador -->
          <div class="mt-4 flex items-center justify-between text-sm" *ngIf="totalCount">
            <div class="text-gray-500">
              Página {{ page }} de {{ totalPages }} • {{ totalCount }} mensajes
            </div>
            <div class="flex gap-2">
              <button [disabled]="page === 1" (click)="onPageChange(page - 1)">Anterior</button>
              <button [disabled]="page >= totalPages" (click)="onPageChange(page + 1)">Siguiente</button>
            </div>
          </div>

          <!-- Nuevo comentario -->
          @if (isLogin && isAdmin) {
            <div class="border-t pt-4">
              <h3 class="text-sm font-semibold mb-2">Nuevo comentario</h3>

              <div class="grid md:grid-cols-3 gap-2 mb-2">
                <select [(ngModel)]="typeId" class="border rounded-md p-2 text-sm">
                  <option *ngFor="let t of messageTypes" [value]="t.id">{{ t.name }}</option>
                </select>

                <select [(ngModel)]="visibility" class="border rounded-md p-2 text-sm">
                  <option *ngFor="let v of visibilities" [value]="v.id">{{ v.label }}</option>
                </select>

                <input *ngIf="visibility === Visibility.PrivateToRecipient"
                       [(ngModel)]="recipientUserId"
                       type="number"
                       class="border rounded-md p-2 text-sm"
                       placeholder="ID destinatario (DM)" />
              </div>

              <textarea [(ngModel)]="newMessageText" rows="3"
                        placeholder="Agregar un comentario…"
                        class="w-full border rounded-md p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
              <div class="mt-2">
                <button
                  class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-1 rounded-md disabled:opacity-50"
                  [disabled]="!newMessageText.trim()"
                  (click)="addNewTopLevelMessage()">
                  Publicar
                </button>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Próximos Pasos -->
      @if (applicationData?.proximosPasos?.length) {
        <div class="border rounded-lg shadow-sm p-4">
          <h2 class="flex items-center text-lg font-semibold mb-2">
            <lucide-angular [img]="CheckCircle" class="h-5 w-5 mr-2"></lucide-angular>
            Próximos Pasos
          </h2>
          <ul class="list-disc pl-5 text-gray-700">
            <li *ngFor="let paso of applicationData!.proximosPasos">{{ paso }}</li>
          </ul>
        </div>
      }
    </div>

    <!-- Sidebar -->
    <div class="space-y-6">
      <!-- Información de la Aplicación -->
      @if (applicationData) {
        <div class="border rounded-lg shadow-sm p-4 space-y-3">
          <h3 class="text-lg font-semibold mb-2">Información de la Aplicación</h3>
          <div>
            <label class="text-sm font-medium text-gray-500">Fecha de Publicación</label>
            <p class="text-gray-900">{{ applicationData.fechaPublicacionVacante }}</p>
          </div>
          <div>
            <label class="text-sm font-medium text-gray-500">Estado Actual</label>
            <p class="mt-1">
              <span class="inline-flex items-center px-2 py-1 rounded-md text-sm font-medium"
                    [ngClass]="getStatusClass(applicationData.estadoId)">
                <i [class]="getStatusIcon(applicationData.estadoId) + ' h-5 w-5 mr-1'"></i>
                {{ getStatusLabel(applicationData.estadoId) }}
              </span>
            </p>
          </div>
        </div>

        <!-- Fecha Límite / Ubicación -->
        <div *ngIf="applicationData" class="border rounded-lg shadow-sm p-4 space-y-3">
          <h3 class="flex items-center text-lg font-semibold mb-2">
            <lucide-angular [img]="Calendar" class="h-5 w-5 mr-2"></lucide-angular>
            Fecha Límite
          </h3>
          <div>
            <label class="text-sm font-medium text-gray-500">Fecha y Hora</label>
            <p class="text-gray-900">{{ applicationData.fechaLimite }}</p>
          </div>
          <div *ngIf="applicationData.direccion">
            <label class="text-sm font-medium text-gray-500">Ubicación</label>
            <p class="text-gray-900">{{ applicationData.direccion }}</p>
          </div>
        </div>

        <!-- Contacto del Reclutador -->
        <div class="border rounded-lg shadow-sm p-4 space-y-3">
          <h3 class="flex items-center text-lg font-semibold mb-2">
            Contacto del Reclutador
          </h3>
          <div class="space-y-1">
            <p class="text-gray-900">{{ applicationData.nombreContacto || 'Director' }}</p>
            <p class="text-gray-900">{{ applicationData.correo }}</p>
            <p class="text-gray-900" *ngIf="applicationData.telefono">{{ applicationData.telefono }}</p>
          </div>
        </div>
      }
    </div>
  </div>
</div>
